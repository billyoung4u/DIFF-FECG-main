# 胎儿心电 AI 算法服务接口文档

本文档描述了胎儿心电监测 AI 算法服务的 HTTP 接口规范。该服务部署于 Docker 容器中，提供基于扩散模型的胎儿心电信号重构与指标计算功能。

## 1. 服务基本信息

- **服务名称**: DIFF-FECG AI Engine
- **协议**: HTTP/1.1
- **数据格式**: JSON
- **默认端口**: 8000

---

## 2. 核心接口：信号推理 (Predict)

该接口接收原始的腹部心电信号，自动进行重采样、滤波、归一化适配，并返回重构后的胎儿心电波形及心率指标。

- **URL**: `http://<服务器IP>:8000/predict`
- **Method**: `POST`
- **Content-Type**: `application/json`

### 2.1 请求参数 (Request)

Body 中需传入一个 JSON 对象，包含以下字段：

| 字段名 | 类型 | 必填 | 说明                                                                                                                 |
| :--- | :--- | :--- |:-------------------------------------------------------------------------------------------------------------------|
| `patient_id` | String | 是 | 病人或记录的唯一标识符（用于日志追踪和结果回传）                                                                                           |
| `fs` | Integer | 是 | **原始数据的采样率** (单位: Hz)。<br>例如：500 或 1000。<br>**注意**：请务必传入设备真实的采样率，否则会导致波形时间轴变形，心率计算严重偏差。算法服务会自动将其重采样适配至模型所需的 200Hz。 |
| `data` | Array[Float] | 是 | 原始腹部心电(AECG)电压值列表。<br>建议长度：1000个点以上 (约 5秒数据)。                                                                      |

**请求示例 (JSON):**

```json
{
  "patient_id": "PID_20241205_001",
  "fs": 500,
  "data": [
    0.012, 0.045, 0.033, -0.012, -0.056, 
    0.123, 0.145, 0.098, ... (此处省略后续数据)
  ]
}

```

### 2.2 返回参数 (Response)

成功请求将返回状态码 `200` 及以下 JSON 数据：

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `code` | Integer | 业务状态码 (200 表示成功, 500 表示内部错误) |
| `msg` | String | 状态描述信息 |
| `patient_id` | String | 原样返回请求中的病人ID |
| `result` | Object | 核心计算结果对象，详情见下表 |

**result 对象结构:**

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `fecg_signal` | Array[Float] | **重建后的胎儿心电信号**。<br>注意：该信号已重采样为 200Hz，长度可能与输入不同（固定为模型窗口长度，如 1000 点）。 |
| `r_peaks` | Array[Integer] | **R 峰位置索引**。<br>对应 `fecg_signal` 数组中的下标位置。 |
| `fhr_bpm` | Float | **瞬时胎心率** (Fetal Heart Rate)，单位：次/分 (bpm)。 |
| `rr_ms` | Float | **RR 间隔**，单位：毫秒 (ms)。 |

**成功响应示例:**

```json
{
  "code": 200,
  "msg": "success",
  "patient_id": "PID_20241205_001",
  "result": {
    "fecg_signal": [0.001, 0.003, 0.05, 0.8, 0.04, ...],
    "r_peaks": [35, 185, 340, 495, 650, 805, 960],
    "fhr_bpm": 142.5,
    "rr_ms": 421.05
  }
}

```

### 2.3 错误响应
```json
{
  "code": 500,
  "msg": "Input signal length is too short. Expected at least 200 points."
}
```

## 3 调用注意事项

- **关于采样率 (fs)**: 算法内部模型固定工作在 200Hz。如果输入的 fs 不是 200，API 会自动执行重采样操作。请务必保证传入的 fs 与实际采集设备的设置一致，否则会导致波形时间轴变形，心率计算严重偏差
- **关于数据长度**: 虽然算法支持自动填充，但为了保证心率计算的稳定性，建议每次 POST 请求发送的数据长度对应时间不小于 5 秒
- **关于单位问题**: 输入数据的电压单位（mV 或 V）不影响结果，因为算法内部会先进行 Z-Score 归一化处理


